# 1 环境规划

## 1.1 集群类型

-   Kubernetes集群大致分为两类：一主多从和多主多从。

-   一主多从：一个Master节点和多台Node节点，搭建简单，但是有单机故障风险，适合用于测试环境。

-   多主多从：多台Master和多台Node节点，搭建麻烦，安全性高，适合用于生产环境。

## 1.2 安装方式

-   kubernetes有多种部署方式，目前主流的方式有kubeadm、minikube、二进制包。

-   ① minikube：一个用于快速搭建单节点的kubernetes工具。

-   ② kubeadm：一个用于快速搭建kubernetes集群的工具。

-   ③ 二进制包：从官网上下载每个组件的二进制包，依次去安装，此方式对于理解kubernetes组件更加有效。

-   我们需要安装kubernetes的集群环境，但是又不想过于麻烦，所以选择kubeadm方式。

## 1.3 主机规划

![](../youdaonote-images/Pasted%20image%2020230313180153.png)

# 2 环境搭建

## 2.1 前言

-   本次环境搭建需要三台CentOS服务器（一主二从），然后在每台服务器中分别安装Docker（18.06.3）、kubeadm（1.18.0）、kubectl（1.18.0）和kubelet（1.18.0）。

> 没有特殊说明，就是三台机器都需要执行。

## 2.2 环境初始化

### 2.2.1 检查操作系统的版本  

-   检查操作系统的版本（要求操作系统的版本至少在7.5以上）：

```Shell
cat /etc/redhat-release
```

![](../youdaonote-images/Pasted%20image%2020230313180534.png)

2.2.2 关闭防火墙和禁止防火墙开机启动  
  
- 关闭防火墙：
- 禁止防火墙开机启动：
```Shell
systemctl stop firewalld

systemctl disable firewalld
```

![](../youdaonote-images/Pasted%20image%2020230313180636.png)

### 2.2.3 设置主机名

-   设置主机名：

```Shell
hostnamectl set-hostname <hostname>
```
-   设置192.168.18.100的主机名：
```Shell
hostnamectl set-hostname k8s-master
```
- 设置192.168.18.101的主机名：
```Shell
hostnamectl set-hostname k8s-node1
```
- 设置192.168.18.102的主机名：
```Shell
hostnamectl set-hostname k8s-node2
```

### 2.2.4 主机名解析

-   为了方便后面集群节点间的直接调用，需要配置一下主机名解析，企业中推荐使用内部的DNS服务器。

```Shell
cat >> /etc/hosts << EOF
192.168.18.100 k8s-master
192.168.18.101 k8s-node1
192.168.18.102 k8s-node2
EOF
```

### 2.2.5 时间同步

-   kubernetes要求集群中的节点时间必须精确一致，所以在每个节点上添加时间同步：

```Shell
yum install ntpdate -y

ntpdate time.windows.com
```

### 2.2.6 关闭selinux

-   查看selinux是否开启：
```Shell
getenforce
```
- 永久关闭selinux，需要重启：
```Shell
sed -i 's/enforcing/disabled/' /etc/selinux/config
```
-   临时关闭selinux，重启之后，无效：
```Shell
setenforce 0
```

### 2.2.7 关闭swap分区

-   永久关闭swap分区，需要重启：
```Shell
sed -ri 's/.*swap.*/#&/' /etc/fstab
```

- 临时关闭swap分区，重启之后，无效：
```Shell
swapoff -a
```

### 2.2.8 将桥接的IPv4流量传递到iptables的链

-   在每个节点上将桥接的IPv4流量传递到iptables的链：

```Shell
cat > /etc/sysctl.d/k8s.conf << EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
vm.swappiness = 0
EOF

# 加载br_netfilter模块
modprobe br_netfilter

# 查看是否加载
lsmod | grep br_netfilter

# 生效
sysctl --system
```

### 2.2.9 开启ipvs  
  
- 在kubernetes中service有两种代理模型，一种是基于iptables，另一种是基于ipvs的。ipvs的性能要高于iptables的，但是如果要使用它，需要手动载入ipvs模块。  
- 在每个节点安装ipset和ipvsadm：
```Shell
yum -y install ipset ipvsadm

# 在所有节点执行如下脚本： 
cat > /etc/sysconfig/modules/ipvs.modules <<EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
EOF

# 授权、运行、检查是否加载：
chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack_ipv4

-   检查是否加载：

lsmod | grep -e ipvs -e nf_conntrack_ipv4
```

### 2.2.10 重启三台机器

-   重启三台Linux机器：
```Shell
reboot
```


## 2.3 每个节点安装Docker、kubeadm、kubelet和kubectl

### 2.3.1 安装Docker

-   安装Docker：