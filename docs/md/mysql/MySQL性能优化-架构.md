
![](../youdaonote-images/Pasted%20image%2020230703235814.png)

## 1、MySQL语句的执行流程
### 1. 客户端与服务端链接
通信类型：同步/异步 通常是同步
连接方式：长连接/短连接 通常是长连接
协议：TCP/Unix Socket 客户端是TCP 本机是Unix Socket

### 2. 一条查询SQL语句是如何执行的?
![image.png](../youdaonote-images/WEBRESOURCE8dad609ccd37e4f45c7d742c6c5891c0.png)

#### 2.1 连接
查看 MySQL 当前有多少个连接:
```sql
show global status like 'Thread%';
```
客户端每产生 一个连接或者一个会话，在服务端就会创建一个线程来处理。反过来如果要杀死会话，就是Kill 线程。服务器并不会立即线程销毁掉，而是把它缓存起来，在另一个新的客户端再进行连接时，把这个缓存的线程分配给该新客户端。

分配线程的话，保持连接肯定会消耗服务端的资源。MySQL 会把那些长时间不活动的 (SLEEP)连接自动断开。

```sql
show global variables like 'wait_timeout'; --非交互式超时时间， 如JDBC 程序 

show global variables like 'interactive_timeout' ; -- 交互式超时时间，如数据库工具
```

默认都为8小时。默认最大连接数是151个，最大可以为100000个。

> MySQL中的参数 (变量)分为session 和global级别，分别是在当前会话中生效和全局生效。当没有带参数的时候，默认是session 级别，包括查询和修改。

#### 2.2 查询缓存
如果两个查询请求在任何字符上的不同（例如：空格、注释、大小写），都会导致缓存不会命中。另外，如果查询请求中包含某些系统函数、用户自定义变量和函数、一些系统表,那这个请求就不会被缓存。

缓存这一块，我们还是交给ORM框架 (比如MyBatis 默 认 开 启 了一 级 缓 存 ) ， 或独立的缓存服务，比如Redis来处理更台适。

 > 检索，查询请求处理完需要更新查询缓存，维护该查询缓存对应的内存区域。5.5之后开始默认关闭，并在MySQL 8.0中删除。

#### 2.3 语法解析和预处理

1. 词法解析：把一个完整的SQL语句打碎成一个个的单词
2. 语法解析：语法分析会对SQL做一些语法检查，比如单弓1号有没有闭合， 然后根据 MySQL定义的语法规则，生成解析树
3. 预处理器：检查生成的解析树，比如检查表名是否存在
![](../youdaonote-images/Pasted%20image%2020230705191017.png)

#### 2.4 查询优化

查询优化器的目的就是根据解析树生成不同的执行计划(ExecutionPlan) ，然后选 择一种最优的执行计划，Mys QL 里面使用的是基于开销 (cost )的优化器，那种执行计
划开销最小，就用哪种。

优化器最终会把解析树变成 一个查询执行计划， 查询执行计划是 一个数据结构。

```sql
# 查看开销
show status like 'Last _query_cost';

# 查看执行计划
EXPLAIN select name from user where id=1;
```

> 我们写的==MySQL==语句执行起来效率可能并不是很高，==MySQL==的优化程序会对我们的语句做一些优化，如外连接转换为内连接

#### 2.5. 存储引擎
MySQL服务器把数据的存储和提取操作都封装到了一个叫存储引擎的模块里。

人们把**连接管理、查询缓存、语法解析、查询优化**这些并不涉及真实数据存储的功能划分为MySQL server的功能，把真实存取数据的功能划分为存储引擎的功能。各种不同的存储引擎向上边的==MySQL server==层提供统一的调用接口（也就是存储引擎API）。

### 3. 存储引擎
#### 3.1 存储引擎比较

- MyISAM (3 个文件): 应用范围比较小。 表级锁定限制 了读/ 写的性能 ，因此在 Web 和数据仓库配置中，它通常用于只读或以读为主的工作。拥有较高的插入和查询速度。
> 怎 么 快 速 向 数 据 库 插 入 1 0 0 万 条 数 据 ? 我 们 有 一 种 先 用 M y I S A M 插 入 数 据 ，然 后
## 2、理解MySQL的架构与内部模块
## 3、InnoDB存储引擎的磁盘与内存结构

