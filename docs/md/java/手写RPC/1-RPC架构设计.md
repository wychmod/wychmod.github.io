# 1. RPC框架整体架构设计

RPC的英文全称是Remote Procedure Call，翻译成中文就是远程过程调用，能够使开发人员像调用本地服务一样调用远程服务。一个较完善的RPC框架总体上可以分为 **服务提供者、注册中心、服务消费者和监控中心** 。其中，服务提供者、注册中心和服务消费者是必需的，而监控中心则可以根据实际情况进行增减。

![](../../youdaonote-images/Pasted%20image%2020241002151849.png)

在一次RPC调用的流程中，服务提供者、注册中心和服务消费者之间的交互流程如下所示。

（1）服务提供者启动后，会将其提供的服务列表信息注册到注册中心。

（2）服务消费者启动后，会向注册中心订阅服务的地址。

（3）当注册中心的服务列表发生变更时，注册中心会主动向服务消费者推送服务列表。

（4）服务消费者会从订阅的服务列表中，按照一定的规则选择其中一个地址，并将调用服务提供者的方法需要的数据通过网络发送给服务提供者。

（5）服务消费者会通过动态代理的方式远程调用服务提供者提供的服务，期间，服务消费者的动态代理模块会将远程调用需要的接口名称、方法名称、方法参数类型列表、方法参数列表等信息序列化成二进制字节流，传输到服务提供者。

（6）服务提供者接收到服务消费者发来的数据后，要先将二进制字节流进行解码，反序列化成原始数据。

（7）服务提供者根据解码后的数据，调用对应的服务，然后将调用结果进行编码，序列化成二进制字节流返回给服务消费者。

（8）服务消费者接收到服务提供者返回的数据后，进行解码，将二进制字节流反序列化成原始数据，进行后续的业务处理。

# 2. RPC框架核心技术点

最核心的技术点大体上包含：服务注册与发现、网络通信协议、序列化与反序列化、RPC调用方式、线程模型、动态代理、负载均衡等。

## 1. 服务注册与发现

在RPC框架中，主要使用注册中心实现服务的注册与发现。服务提供者上线后将自身的服务列表注册到注册中心，当服务提供者下线时，从注册中心中移除自身的服务列表。服务消费者上线后，向注册中心订阅服务提供和的服务列表，然后通过负载均衡算法选择其中一个服务节点进行调用。

为防止由于断网、系统宕机、程序崩溃等问题造成的注册中心一直残留无效服务列表的问题，在引入注册中心时，要采取 **主动通知+心跳检测 的方案。**

## 2.网络通信协议

RPC框架最主要的功能就是实现RPC远程过程调用，涉及到远程过程调用，那就一定是通过网络进行的，此时就必须通过某种网络通信协议进行数据交互，需要考虑采用哪些方式实现数据的编解码。

由于在分布式系统中，对RPC框架有着极高的性能要求，所以，在RPC框架中，网络通信协议的实现越简单越好，尽可能减少数据编解码和在网络传输过程中的性能损耗。

通用的网络协议有HTTP、TPC、UDP等，RPC框架可以基于这些通用的网络通信协议实现，也可以根据实际需求，实现自定义的网路通信协议。

## 3.序列化与反序列化

数据在网路上进行传输时，需要将原始数据采用某种编码方式序列化成二进制字节流在网络上传输，不管是服务提供者还是服务消费者接收到数据后，都需要将二进制字节流数据反序列化成原始数据。

为了尽可能降低序列化和反序列化带来的性能问题，一般在RPC框架中会选择比较高效的序列化算法。常用的序列化框架有：**FastJson、Kryo、Hessian、Protobuf**等。

## 4.RPC调用方式

一个成熟的RPC框架，例如Dubbo等会提供四种不同的调用方式，分别为：同步调用(Sync)、异步调用(Future)、回调(Callback)、单向调用(Oneway)。

### 4.1同步调用(Sync)

同步调用(Sync)：服务消费者发起RPC调用后，线程会一直阻塞，直到服务提供者返回结果或者超时异常。在RPC框架中，一般会采用同步调用的方式，但是在RPC框架内部的实现中，本质上还是采用的是异步处理。例如，Dubbo中就存在着经典的异步转同步的逻辑。另外，当采用同步调用方式时，要设置超时时间。如下图所示。

![](../../youdaonote-images/Pasted%20image%2020241004010512.png)

### 4.2异步调用(Future)
异步调用(Future):服务消费者发起RPC调用后，线程不会阻塞，获取到RPC框架返回的Future对
象。RPC调用的结果数据会被服务提供者缓存起来，服务消费者根据自身实际情况决定获取结果数据。当服务消费者主动获取异步结果数据时是阻塞的。如下图所示。

![](../../youdaonote-images/Pasted%20image%2020241004010632.png)

### 4.3 回调(Callback)

回调(Callback)：服务消费者发起RPC调用后，会将回调接口Callback对象发送给RPC框架。此
时也不需要同步等待RPC框架的返回结果，直接返回。当RPC框架接收到服务提供者处理的结果数
据或者超时异常后，会执行Callback回调。一般在定义和实现Callback接口时，都要实现处理成功
的方法和异常方法。例如success(Object result)方法和fail(Exception e)方法。

![](../../youdaonote-images/Pasted%20image%2020241004010832.png)

