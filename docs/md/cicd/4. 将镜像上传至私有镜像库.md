## 什么是镜像库

字面意思，镜像库就是集中存放镜像的一个文件服务。镜像库在 `CI/CD` 中，又称 `制品库` 。构建后的产物称为**制品**，制品则要放到**制品库**做**中转和版本管理**。常用平台有**Nexus，Jfrog，Harbor**或其他对象存储平台。

在这里，我们选用 `Nexus3` 作为自己的镜像库。因为其稳定，性能好，免费，部署方便，且支持类型多，是许多制品库的首选选型。

## 部署 Nexus 服务

在部署 `Nexus` 之前，需要先下载 `Nexus` 的安装包（这里需要另外找个托管服务）

```shell
wget https://dependency-fe.oss-cn-beijing.aliyuncs.com/nexus-3.29.0-02-unix.tar.gz
```

下载完成后，解压安装包

```shell
tar -zxvf ./nexus-3.29.0-02-unix.tar.gz
```

解压后，我们可以看到有2个文件夹。分别是 `nexus-3.29.0-02` 和 `sonatype-work` 。其中，`nexus-3.29.0-02` 是nexus主程序文件夹，`sonatype-work` 则是数据文件。

## 启动 Nexus

我们进入 `nexus-3.29.0-02` 下面的 `bin` 目录，这里就是 `nexus` 的主命令目录。我们在 `bin` 目录下，执行 `./nexus start` 命令即可启动 `nexus` ：

```shell
./nexus start
```

> nexus 还支持停止，重启等命令。可以在 bin 目录下执行 ./nexus help 查看更多命令

由于 `nexus` 默认服务端口是 `8081`，稍后我们还需要给镜像库访问单独开放一个 `8082` 端口。这里将 `8081`，`8082` 端口添加到防火墙放行规则内（没开防火墙则可以略过）：

```shell
firewall-cmd --zone=public --add-port=8081/tcp --permanent
firewall-cmd --zone=public --add-port=8082/tcp --permanent
```

打开浏览器地址栏，访问 `IP:8081` 。启动时间比较长，需要耐心等待。在 `Nexus` 启动后，会进入这个欢迎页面：

![](../youdaonote-images/Pasted%20image%2020230417234351.png)

## 配置 Nexus

进入欢迎页后，点击右上角的登录，会打开登录框。这里需要我们输入 `默认管理员密码` 进行初始化配置。

![](../youdaonote-images/Pasted%20image%2020230417234408.png)

可以在这里找到：

```shell
cat /opt/nexus/sonatype-work/nexus3/admin.password
# 0ee35fa5-d773-432b-8e76-6c10c940ccd9
```

将文件中获取到的密码输入进去，登录用户名是 `admin` 。

接着是修改新密码。修改后，会进入下图这一步。这一步的意思是**是否开启匿名访问**。匿名访问是指：**我们在没有登录的情况下，拉取（推送）制品到制品库，都算匿名访问。**这是个很便捷，也是个危险的行为。

![](../youdaonote-images/Pasted%20image%2020230417234438.png)

## 创建一个 Docker 私服

登录完成后，点击页面头部导航栏的**齿轮**图标，选择左侧菜单中的 `Repositories` ，点击 `Create repository` 。

![](../youdaonote-images/Pasted%20image%2020230417234605.png)

点击后，我们可以看到一个列表，这就是 `Nexus` 所支持的制品库类型。其中有我们要使用的 `Docker` ，也有我们熟悉的 `Npm` 。我们在里面找到 `Docker` ：

![](../youdaonote-images/Pasted%20image%2020230417234927.png)

### 选择制品库的类型

在 `nexus` 中，制品库一般分为以下三种类型：

-   proxy: 此类型制品库原则上**只下载，不允许用户推送**。可以理解为**缓存外网制品的制品库**。例如，我们在拉取 `nginx` 镜像时，如果通过 `proxy` 类型的制品库，则它会去创建时配置好的外网 `docker` 镜像源拉取（有点像 `cnpm` ）到自己的制品库，然后给你。第二次拉取，则不会从外网下载。起到 `内网缓存` 的作用。
-   hosted：此类型制品库和 `proxy` 相反，原则上 `只允许用户推送，不允许缓存`。这里只存放自己的私有镜像或制品。
-   group：此类型制品库可以将以上两种类型的制品库组合起来。组合后只访问 `group` 类型制品库，就都可以访问。
在这里，我们其实不需要**缓存外网镜像**，那么我们只需要 `hosted` 即可。选择 `docker (hosted)`。

我们将启动 `Nexus` 镜像时，配置好的 `Docker` 端口（预留了一个 `8082` 端口）填入 `HTTP` 输入框内。这里可以先允许匿名拉取镜像。

![](../youdaonote-images/Pasted%20image%2020230417235054.png)